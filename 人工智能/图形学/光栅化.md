https://zhuanlan.zhihu.com/p/44755869 管线介绍
光栅化gpu阶段
![[光栅化gpu阶段.jpeg]]
## 顶点、图元、片元、像素
https://www.jianshu.com/p/e0c7c64bac22

## 顶点处理

## 图元装配

## 光栅化

## 深度和模板测试
## 片段着色器

## z-buffer
在计算机图形学中，Z-buffer（也称为深度缓冲）是一种管理图像深度坐标的方法，它用于实现图像的深度测试以决定像素的遮挡关系。Z-buffering是3D图形硬件广泛使用的技术，它允许硬件正确渲染重叠的3D对象。以下是Z-buffer管线的详细步骤：

### 1. 管线开始：顶点阶段
在光栅化渲染管线的最开始，模型的顶点数据被处理。顶点着色器（Vertex Shader）运行并对每个顶点进行变换，将它们从本地空间转换到世界空间，然后是视图空间，最后是投影空间。在投影空间中，每个顶点的Z值表示其相对于视点的深度。

### 2. 三角形设置和光栅化
经过投影变换后，顶点数据被传递到光栅化器，它将三角形从投影空间转换到屏幕空间，并确定哪些像素属于该三角形。在这个过程中，每个像素的深度值（Z值）也被计算出来。

### 3. 深度测试前的像素处理
在像素（片元）着色器（Fragment Shader）运行之前，每个像素的深度值会与Z-buffer中对应像素的深度值进行比较。如果没有启用深度测试，这个步骤会被跳过。

### 4. 深度测试
对于每个像素，GPU会执行深度测试：
- 如果启用了深度写入（depth writing），且当前像素的深度值小于或等于（根据深度测试函数）Z-buffer中的值，那么当前像素的颜色和深度值会被写入颜色缓冲和Z-buffer中。
- 如果当前像素的深度值大于Z-buffer中的值，那么这个像素将被丢弃，不会对颜色缓冲区产生影响。

### 5. 深度值更新
如果深度测试通过，Z-buffer会被更新为新的深度值。如果深度测试失败，Z-buffer保持不变。

### 6. 颜色写入
一旦深度测试通过，像素的颜色值就会被送到颜色缓冲区。这可能涉及其他测试和操作，如模板测试、混合操作等。

### 7. 最终像素输出
经过所有测试和处理后，最终的像素颜色值会被写入帧缓冲区，最终在屏幕上显示。

### 优化
在现代图形管线中，通常还有很多优化和变体，例如：
- **早期深度测试**：在像素着色器运行之前进行深度测试，如果测试失败，则可以避免运行像素着色器，从而提高效率。
- **深度预传递**：在执行完整的渲染管线之前，先进行一次只有深度测试的渲染遍历，以填充Z-buffer，从而优化后续的渲染过程。

Z-buffering是一种相对直接的方法，可以有效地解决隐藏面消除问题，并且已经被集成到了所有现代图形处理单元（GPUs）中。然而，它也有一些限制，例如它不能处理透明对象的排序问题，这通常需要更复杂的技术如排序透明度（Order Independent Transparency）来解决。